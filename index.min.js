$(document).ready((function(){let e=document.querySelector("ul#list-equipement");document.createDocumentFragment();$("#play-date").get(0).style.display="block";const t=L.map("map",{zoomControl:!1,center:[45.43798463466298,4.385923767089852],zoom:12,scrollWheelZoom:!0});var n=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.carto.com">CARTO</a> OpenStreetMap, contributors',opacity:1});n.addTo(t);var a=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:0,maxZoom:20,attribution:"© OpenStreetMap contributors, Tiles style by Humanitarian OpenStreetMap",ext:"jpg"});a.addTo(t);const i=L.layerGroup().addTo(t),d=L.layerGroup().addTo(t),o=L.layerGroup();fetch("docs/fond_carte/Quartier.geojson").then((e=>e.json())).then((e=>{const t=L.geoJSON(e,{onEachFeature:function(e,t){t.bindPopup(e.properties.code_2018.toString())},style:{fillOpacity:.09,opacity:.8,weight:1,dashArray:"4, 10",color:"#FFD133"}});o.addLayer(t)})).catch((e=>{console.error("Erreur lors du chargement du fichier GeoJSON:",e)}));const l=({latitude:e,longitude:t,pratique:n,domaine:a,id:d},o)=>{const l=getIconUrl(a),r=L.icon({iconUrl:l,iconSize:[20,35],iconAnchor:[10,35],popupAnchor:[0,-35]}),s=L.marker([e,t],{icon:r}).bindPopup(n);return i.addLayer(s),s.on("click",(function(){const e=DataComplexe.find((e=>e.id===d)),t=DataCotes.find((e=>e.id_cote===d&&"D"===e.types)),n=DataCotes.find((e=>e.id_cote===d&&"I"===e.types)),a=DataCotes.find((e=>e.id_cote===d&&"P"===e.types)),i=e?e.description:"Non disponible",o=DataImages.find((e=>e.id_image===d&&1===e.num)),l=DataImages.find((e=>e.id_image===d&&1===e.num)),r=DataImages.find((e=>e.id_image===d&&2===e.num)),s=DataImages.find((e=>e.id_image===d&&3===e.num)),m=DataImages.find((e=>e.id_image===d&&4===e.num)),u=DataImages.find((e=>e.id_image===d&&5===e.num));document.getElementById("titre-description").innerHTML=e?e.name:"Non disponible",document.getElementById("texte-description").innerHTML=i?truncateText(i,150):"Données indisponibles",document.getElementById("description").innerHTML=e?e.description:"Non disponible",document.getElementById("titre").innerHTML=e?e.name:"Non disponible",document.getElementById("addresse").innerHTML=e?e.adresse:"Non disponible",document.getElementById("docs_event").innerHTML=e?e.event:"Non disponible",document.getElementById("docs_ecrit").innerHTML=t?t.description_c:"Non disponible",document.getElementById("docs_icono").innerHTML=n?n.description_c:"Non disponible",document.getElementById("docs_plan").innerHTML=a?a.description_c:"Non disponible",function(e,t,n){const a=document.getElementById(e),i=document.getElementById(t);document.getElementById("id_img0_modal");if(a&&i){const e=n?n.url:"assets/images/no-image-found.svg";a.src=e,i.href=e}}("id_img0","lien_img0",o),c("id_img1","lien_img1",l),c("id_img2","lien_img2",r),c("id_img3","lien_img3",s),c("id_img4","lien_img4",m),c("id_img5","lien_img5",u);const p=document.getElementById("full-description");p&&p.hasAttribute("open")||document.getElementById("view_description").setAttribute("open",!0)})),s};function c(e,t,n){const a=document.getElementById(e),i=document.getElementById(t);if(a&&i){const e=n?n.url:"";a.src=e,i.href=e}}const r=({latlngs:e,pratique:t,domaine:n,id_forme:a},i)=>{const o=L.polygon(e,{cfillOpacity:.1,color:"#3333ff",lineOpacity:.1,opacity:.1});return d.addLayer(o),o};var s={OpenSteetMap:a,Cartho:n},m={Marker:i,Forme:d,Quartier:o};L.control.layers(s,m,{position:"bottomleft"}).addTo(t),L.control.zoom({position:"bottomleft"}).addTo(t);let u=document.querySelector("ul#list-filtre");const p=document.createDocumentFragment(),g=new Set;DataEquipements.forEach((e=>{if(!g.has(e.domaine)){const t=document.createElement("li"),n=document.createElement("img");n.src=getIconUrl(e.domaine),n.alt=e.domaine,n.style.width="20px",n.style.height="20px";const a=document.createElement("span");a.innerText=e.domaine,t.appendChild(n),t.appendChild(a),t.dataset.lat=e.lat,t.dataset.lon=e.lon,p.appendChild(t),g.add(e.domaine)}})),u.appendChild(p);let y=document.querySelector("ul#second-filtre");const h=document.createDocumentFragment(),E=new Set;DataEquipements.forEach((e=>{if(!E.has(e.type)){const t=document.createElement("li"),n=document.createElement("span"),a=document.createElement("input");a.type="checkbox",a.id=`switch-${e.type}`,a.dataset.type=e.type,n.innerText=e.type;const i=document.createElement("label");i.htmlFor=a.id,i.appendChild(a),i.appendChild(n),t.appendChild(a),t.appendChild(i),t.dataset.lat=e.lat,t.dataset.lon=e.lon,h.appendChild(t),E.add(e.type)}})),y.appendChild(h);const f=document.getElementById("masque-switch");let I=!1,_=!1,b=null,q=null,B=[],T=[],D=document.getElementById("date-slider").value;function v(){const n=document.getElementById("date-slider").value,a=new Date(n);let o=DataEquipements.filter((e=>{const t=!b||e.domaine===b,n=0===B.length||B.includes(e.type),i=new Date(e.dateD)<=a&&new Date(e.dateF)>=a,d=!I||e.p_cotes;return t&&n&&i&&d})),c=DataFormes.filter((e=>{const t=!_||e.p_cotes,n=!q||e.domaine===q,i=!q||e.domaine===q,d=0===T.length||T.includes(e.type),o=new Date(e.dateD_shape)<=a&&new Date(e.dateF_shape)>=a;return t&&n&&i&&d&&o}));!function(e,n){i.clearLayers(),d.clearLayers();let a=0;e.forEach((e=>{e.latitude&&e.longitude&&(l({latitude:e.latitude,longitude:e.longitude,pratique:e.pratique,domaine:e.domaine,id:e.id_equip},t),a++)})),n.forEach((e=>{e.latlngs&&e.latlngs.length>0&&r({latlngs:e.latlngs,pratique:e.pratique,domaine:e.domaine,id_forme:e.id_forme,p_cotes:e.p_cotes},t)})),t.hasLayer(i)||i.addTo(t);t.hasLayer(d)||d.addTo(t);o=a,document.getElementById("Nb_equip").innerText=`Nombre d'équipements: ${o}`;var o}(o,c),function(t){e.innerHTML="";const n=document.createDocumentFragment();DataComplexe.forEach((e=>{const a=ensembleEquipements[e.id]?.filter((e=>t.includes(e)))||[];if(a.length>0){const t=document.createElement("li");t.innerHTML=e.name,t.dataset.lat=e.lat,t.dataset.lon=e.lon;const i=document.createElement("ul");i.classList.add("sub-list","hidden"),a.forEach((e=>{const t=document.createElement("li");t.classList.add("equip-item");const n=document.createElement("img");n.src=getIconUrl(e.domaine),n.alt=e.pratique,n.style.width="20px",n.style.height="20px";const a=document.createElement("span");a.innerText=e.pratique,t.appendChild(n),t.appendChild(a),i.appendChild(t),t.dataset.lat=e.latitude,t.dataset.lon=e.longitude,t.dataset.pratique=e.pratique})),t.appendChild(i),n.appendChild(t)}})),e.appendChild(n)}(o);let s=o.map((e=>e.domaine));s=[...new Set(s)];x(null!==b?s:[])}function x(e){const t=document.getElementById("Filtre-actu");t.innerHTML=e||"Aucun"}f.addEventListener("change",(e=>{I=e.target.checked,v()})),u.addEventListener("click",(({target:e})=>{const t=e.closest("li");if(!t)return;const n=t.querySelector("span").innerText.trim();n===b?(b=null,x(null)):b=n,v()})),y.addEventListener("click",(({target:e})=>{"INPUT"===e.tagName&&"checkbox"===e.type&&(B=Array.from(y.querySelectorAll('input[type="checkbox"]:checked')).map((e=>e.dataset.type)),v())})),f.addEventListener("change",(e=>{_=e.target.checked,v()})),u.addEventListener("click",(({target:e})=>{const t=e.closest("li");if(!t)return;const n=t.querySelector("span").innerText.trim();n===q?(q=null,x(null)):q=n,v()})),y.addEventListener("click",(({target:e})=>{"INPUT"===e.tagName&&"checkbox"===e.type&&(T=Array.from(y.querySelectorAll('input[type="checkbox"]:checked')).map((e=>e.dataset.type)),v())})),document.getElementById("date-slider").addEventListener("input",(()=>{v()}));const C=document.querySelectorAll("#dateDisplay, #dateDisplay2");function N(e){C.forEach((t=>t.innerText=`Date: ${e}`))}N(D);const k=document.getElementById("startButton"),S=document.getElementById("resetButton");let w;function M(){N(document.getElementById("date-slider").value),v()}k.addEventListener("click",(()=>{w?(clearInterval(w),k.textContent="☐",w=null):(w=setInterval((()=>{let e=parseInt(document.getElementById("date-slider").value)+1;e>2023&&(e=1900),document.getElementById("date-slider").value=e,M()}),200),k.textContent="Stop")})),S.addEventListener("click",(()=>{document.getElementById("date-slider").value=1900,N(1900),M()})),fin.addEventListener("click",(()=>{document.getElementById("date-slider").value=2023,N(2023),M()})),v();document.getElementById("resetAll-Filtre").addEventListener("click",(()=>{I=!1,_=!1,b=null,q=null,B=[],T=[],D=2023,document.getElementById("date-slider").value=D,document.getElementById("masque-switch").checked=!1,N(D),document.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=!1})),v()})),e.addEventListener("click",(n=>{const a=n.target.closest("li");if(a&&a.parentElement===e){const e=a.querySelector("ul.sub-list");e&&e.classList.toggle("hidden");const n=Number(a.dataset.lat),i=Number(a.dataset.lon);isNaN(n)||isNaN(i)||t.flyTo([n,i],17)}})),e.addEventListener("click",(e=>{const n=e.target.closest(".equip-item");if(n){const e=n.dataset.lat,a=n.dataset.lon,i=n.dataset.pratique;isNaN(e)||isNaN(a)||L.popup().setLatLng([e,a]).setContent(`<strong>Pratique:</strong> ${i}`).openOn(t)}}))}));
